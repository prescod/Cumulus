<apex:page controller="STG_PanelDataImportMapping_CTRL" docType="html-5.0" standardStylesheets="false">

    <apex:slds/>
    <apex:includeScript value="{!URLFOR($Resource.CumulusStaticResources, '/npsp-slds/modal.js')}" />

    <div class="slds-scope">
        <apex:form id="form" styleClass="slds-m-around_x-large">
            <c:STG_PageHeader sectionLabel="{!$Label.stgNavBulkProcesses}" pageLabel="{!$Label.bdiCustomObjectMappingSummary}" />

            <c:UTIL_PageMessages allowClose="false" id="messages" />
            <c:UTIL_PageMessageInfo isRendered="{!NOT(isAdmin)}" message="{!$Label.stgDIFMNonAdminError}" />

            <!-- BEGIN INTRO TEXT AND TOGGLE -->
            <!-- TODO drop isConflict condition into child class, combine with isPolling condition -->
            <div class="{!IF(isConflict, 'slds-hide', '')}">
                <div class="slds-grid {!IF(!isPolling, '', 'slds-hide')}">
                    <apex:outputPanel>
                        <div class="slds-m-vertical_medium">
                            <c:UTIL_HtmlOutput html="{!$Label.stgHelpBDICustomObjectMappingEnable}" hasLink="true" styleClass="slds-text-body_small" />
                        </div>

                        <label class="slds-checkbox_toggle slds-grid slds-m-vertical_small" style="width: fit-content;">
                            <span class="slds-form-element__label slds-m-bottom_none">{!$Label.bdiCustomObjectMappingSummary}</span>
                            <apex:inputCheckbox onClick="toggle(); return false;"
                                                id="enableDIFMToggle"
                                                html-name="checkbox-toggle-2"
                                                value="{!isDataImportFieldMapping}"
                                                html-aria-describedby="checkbox-toggle-2" />
                            <span class="slds-checkbox_faux_container" aria-live="assertive">
                                <span class="slds-checkbox_faux"></span>
                                <span class="slds-checkbox_on">Enabled</span>
                                <span class="slds-checkbox_off">Disabled</span>
                            </span>
                        </label>
                    </apex:outputPanel>
                </div>
            </div>
            <!-- END -->

            <!-- BEGIN CONFLICT TEXT -->
            <!-- TODO drop isConflict condition into child class, combine with isPolling condition -->
            <div class="{!IF(isConflict, '', 'slds-hide')}">
                <div class="slds-grid slds-m-top_small {!IF(!isPolling, '', 'slds-hide')}">
                    <div class="slds-size_1-of-1">
                        <article class="slds-card">
                            <div class="slds-card__header slds-grid">
                                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                    <div class="slds-media__figure">
                                        <span class="slds-icon_container slds-icon-utility-warning slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                                            <svg class="slds-icon" aria-hidden="true" viewBox="0 0 24 24">
                                                <path style="fill: #514f4d;" d="M23.7 19.6L13.2 2.5c-.6-.9-1.8-.9-2.4 0L.3 19.6c-.7 1.1 0 2.6 1.1 2.6h21.2c1.1 0 1.8-1.5 1.1-2.6zM12 18.5c-.8 0-1.4-.6-1.4-1.4s.6-1.4 1.4-1.4 1.4.6 1.4 1.4-.6 1.4-1.4 1.4zm1.4-4.2c0 .3-.2.5-.5.5h-1.8c-.3 0-.5-.2-.5-.5v-6c0-.3.2-.5.5-.5h1.8c.3 0 .5.2.5.5v6z"
                                                />
                                            </svg>
                                            <span class="slds-assistive-text">warning</span>
                                        </span>
                                    </div>
                                    <div class="slds-media__body">
                                        <h2 class="slds-card__header-title">
                                            Standard Help Text Mappings have been changed in your org.
                                        </h2>
                                    </div>
                                </header>
                            </div>
                            <div class="slds-card__body slds-card__body_inner">
                                <p>Would you like to keep or discard your help text mapping customizations?</p>
                            </div>
                            <footer class="slds-card__footer">
                                <button class="slds-button slds-button_neutral" onclick="handleKeepCustomizations();return false;">Keep Customizations</button>
                                <button class="slds-button slds-button_destructive" onclick="handleDiscardCustomizations();return false;">Discard Customizations</button>
                            </footer>
                        </article>
                    </div>
                </div>
            </div>
            <!-- END -->

            <!-- BEGIN POLLING MESSAGE -->
            <div class="slds-card slds-m-top_medium {!IF(isPolling,'','slds-hide')}">
                <div class="slds-col slds-size_1-of-1 slds-m-around_medium">
                    <p class="slds-text-body_small slds-m-top_x-small">
                        <apex:outputText rendered="{!isPolling}" value="{!$Label.stgDeploymentInProgress}" />
                    </p>
                </div>
            </div>
            <!-- END POLLING MESSAGE -->

            <!-- CONFLICTS DATATABLE -->
            <div class="slds-grid slds-wrap slds-m-top_large {!IF(isPolling,'slds-hide','')}">
                <div class="slds-size_1-of-1 {!IF(conflictingMappings.size > 0,'','slds-hide')}">
                    <div class="slds-text-heading_medium slds-p-bottom_medium">Pending Modified Standard Mappings</div>

                    <table class="slds-card slds-table slds-table_cell-buffer slds-table_bordered">
                        <thead>
                            <tr class="slds-line-height_reset">
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Data Import Field Label">Data Import Field Label</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Expected">Expected Help Text Field Value</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Found">Found Help Text Field Value</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <apex:repeat value="{!conflictingMappings}" var="cmt">
                                <tr class="slds-hint-parent">
                                    <th data-label="{!cmt.label}" scope="row">
                                        <div class="slds-truncate" title="{!cmt.label}">{!cmt.label}</div>
                                    </th>
                                    <td data-label="{!IF(cmt.expectedHelpTextValue == 'New Mapping', 'New Mapping' ,cmt.dataImportObjectName + '.' + cmt.expectedHelpTextValue)}">
                                        <div class="slds-truncate" title="{!IF(cmt.expectedHelpTextValue == 'New Mapping', 'New Mapping' , cmt.expectedHelpTextValue)}">{!IF(cmt.expectedHelpTextValue == 'New Mapping', 'New Mapping' , cmt.expectedHelpTextValue)}</div>
                                    </td>
                                    <td data-label="{!cmt.dataImportObjectName + '.' + cmt.targetFieldAPIName}">
                                        <div class="slds-truncate" title="{!cmt.dataImportObjectName + '.' + cmt.targetFieldAPIName}">{!cmt.dataImportObjectName + '.' + cmt.targetFieldAPIName}</div>
                                    </td>
                                </tr>
                            </apex:repeat>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- END CONFLICTS DATATABLE -->

            <!-- PENDING DATATABLE -->
            <div class="slds-grid slds-wrap slds-m-top_large {!IF(isPolling,'slds-hide','')}">
                <div class="slds-size_1-of-1 {!IF(pendingMappings.size > 0,'','slds-hide')}">
                    <div class="slds-text-heading_medium slds-p-bottom_medium">Pending New Custom Mappings</div>

                    <table class="slds-card slds-table slds-table_cell-buffer slds-table_bordered">
                        <thead>
                            <tr class="slds-line-height_reset">
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Data Import Field Label">Data Import Field Label</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Expected">Found Help Text Field Value</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <apex:repeat value="{!pendingMappings}" var="cmt">
                                <tr class="slds-hint-parent">
                                    <th data-label="{!cmt.label}" scope="row">
                                        <div class="slds-truncate" title="{!cmt.label}">{!cmt.label}</div>
                                    </th>
                                    <td data-label="{!cmt.dataImportObjectName + '.' + cmt.targetFieldAPIName}">
                                        <div class="slds-truncate" title="{!cmt.dataImportObjectName + '.' + cmt.targetFieldAPIName}">{!cmt.dataImportObjectName + '.' + cmt.targetFieldAPIName}</div>
                                    </td>
                                </tr>
                            </apex:repeat>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- END PENDING DATATABLE -->

            <!-- PENDING DATATABLE -->
            <div class="slds-grid slds-wrap slds-m-top_large {!IF(isPolling,'slds-hide','')}">
                    <div class="slds-size_1-of-1 {!IF(createdMappings.size > 0,'','slds-hide')}">
                        <div class="slds-text-heading_medium slds-p-bottom_medium">Created Mappings</div>

                        <table class="slds-card slds-table slds-table_cell-buffer slds-table_bordered">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th class="" scope="col">
                                        <div class="slds-truncate" title="Label">Label</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <apex:repeat value="{!createdMappings}" var="cmt">
                                    <tr class="slds-hint-parent">
                                        <th data-label="{!cmt.label}" scope="row">
                                            <div class="slds-truncate" title="{!cmt.label}">{!cmt.label}</div>
                                        </th>
                                    </tr>
                                </apex:repeat>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- END PENDING DATATABLE -->

            <apex:actionPoller action="{!checkDeploymentStatus}" enabled="{!isPolling}" reRender="form" interval="5" status="deploymentStatus"/>

            <apex:actionFunction name="enableDataImportFieldMapping" action="{!enableDataImportFieldMapping}" reRender="form, status, idPanelSchedule, idPanelConRole, idPanelMembership, idPanelAllocations, UDRsTreeItem, donorStatsTreeItem"
                status="statusLoad" />
            <apex:actionFunction name="disableDataImportFieldMapping" action="{!disableDataImportFieldMapping}" reRender="form, status, idPanelSchedule, idPanelConRole, idPanelMembership, idPanelAllocations, UDRsTreeItem, donorStatsTreeItem"
                status="statusLoad" />
            <apex:actionFunction name="keepCustomizations" action="{!keepCustomizations}" reRender="form, status, idPanelSchedule, idPanelConRole, idPanelMembership, idPanelAllocations, UDRsTreeItem, donorStatsTreeItem"
                status="statusLoad" />
            <apex:actionFunction name="discardCustomizations" action="{!discardCustomizations}" reRender="form, status, idPanelSchedule, idPanelConRole, idPanelMembership, idPanelAllocations, UDRsTreeItem, donorStatsTreeItem"
                status="statusLoad" />

        </apex:form>

        <script type="text/javascript">
            function toggle() {
                if (document.getElementById('{!$Component.form.enableDIFMToggle}').checked) {
                    enableDataImportFieldMapping();
                } else {
                    disableDataImportFieldMapping();
                }
            }

            function handleDiscardCustomizations() {
                console.log('Attempting to discard customizations');
                discardCustomizations();
            }

            function handleKeepCustomizations() {
                console.log('Attempting to keep customizations');
                keepCustomizations();
            }
        </script>

    </div>

</apex:page>
